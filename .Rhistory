water_data <- water_data %>%
filter(QCStatus %in% c("QC4", "QC5"))
cat("  ‚úÖ Kept", nrow(water_data), "samples out of", original_count, "\n\n")
} else {
cat("  ‚ö†Ô∏è  No QCStatus column found, keeping all data\n\n")
}
# RULE 2: Remove CENSORED data (marked with ##)
# These are like broken crayons - we can't use them!
cat("Rule 2: Removing censored data (marked with ##)...\n")
censored_columns <- c("ResVal", "SECCHI", "MAXDEPTH")
for(col in censored_columns) {
if(col %in% names(water_data)) {
before <- nrow(water_data)
water_data <- water_data %>%
filter(is.na(get(col)) | !grepl("##", as.character(get(col)), fixed = TRUE))
removed <- before - nrow(water_data)
if(removed > 0) cat("  ‚úÖ Removed", removed, "censored values from", col, "\n")
}
}
cat("\n")
# RULE 3: Handle Missing Data (marked with -- or ** or ^^)
# These are like empty spaces in a coloring book
cat("Rule 3: Handling missing data symbols...\n")
# Only apply to CHARACTER columns (text columns, not number columns)
# This is like only erasing pencil marks, not pen marks!
water_data <- water_data %>%
mutate(across(where(is.character), ~na_if(., "--"))) %>%
mutate(across(where(is.character), ~na_if(., "**"))) %>%
mutate(across(where(is.character), ~na_if(., "^^"))) %>%
mutate(across(where(is.character), ~na_if(., "")))  # Also handle empty strings
cat("  ‚úÖ Converted missing symbols to NA (empty)\n\n")
# RULE 4: Handle Non-Detects (values starting with <)
# When scientists can't measure something because it's too small!
cat("Rule 4: Processing non-detect values (< symbols)...\n")
# The numeric columns already handle this - negative values mean "less than"
# We'll use the numeric columns (nResult, nSECCHI, etc.) which are already converted!
cat("  ‚úÖ Using numeric columns that follow Mass.gov rules\n\n")
# RULE 5: Remove data with quality flags that indicate problems
# Clear everything (like cleaning your desk before homework)
rm(list = ls())
# Load our helper tools (like getting out your pencils and crayons)
if (!require("readxl")) install.packages("readxl")
if (!require("dplyr")) install.packages("dplyr")
if (!require("tidyr")) install.packages("tidyr")
if (!require("ggplot2")) install.packages("ggplot2")
if (!require("randomForest")) install.packages("randomForest")
if (!require("caret")) install.packages("caret")
if (!require("corrplot")) install.packages("corrplot")
if (!require("rpart")) install.packages("rpart")
if (!require("rpart.plot")) install.packages("rpart.plot")
if (!require("gridExtra")) install.packages("gridExtra")
if (!require("RColorBrewer")) install.packages("RColorBrewer")
library(readxl)
library(dplyr)
library(tidyr)
library(ggplot2)
library(randomForest)
library(caret)
library(corrplot)
library(rpart)
library(rpart.plot)
library(gridExtra)
library(RColorBrewer)
cat("üìÇ Opening the water quality data file...\n")
file_path <- "C:\\Users\\minak\\Downloads\\labdatamain-8-23-2022.xlsx"
water_data <- read_excel(file_path)
cat("‚úÖ Found", nrow(water_data), "water samples!\n")
cat("‚úÖ Each sample has", ncol(water_data), "pieces of information!\n\n")
cat("üßπ Starting to clean the data...\n\n")
# RULE 1: Only use QC4 and QC5 data (these are the "final, good" data!)
# QC1, QC2, QC3 are like practice drawings - not ready to show yet!
cat("Rule 1: Keeping only FINAL quality data (QC4 and QC5)...\n")
original_count <- nrow(water_data)
if("QCStatus" %in% names(water_data)) {
water_data <- water_data %>%
filter(QCStatus %in% c("QC4", "QC5"))
cat("  ‚úÖ Kept", nrow(water_data), "samples out of", original_count, "\n\n")
} else {
cat("  ‚ö†Ô∏è  No QCStatus column found, keeping all data\n\n")
}
# RULE 2: Remove CENSORED data (marked with ##)
# These are like broken crayons - we can't use them!
cat("Rule 2: Removing censored data (marked with ##)...\n")
censored_columns <- c("ResVal", "SECCHI", "MAXDEPTH")
for(col in censored_columns) {
if(col %in% names(water_data)) {
before <- nrow(water_data)
water_data <- water_data %>%
filter(is.na(get(col)) | !grepl("##", as.character(get(col)), fixed = TRUE))
removed <- before - nrow(water_data)
if(removed > 0) cat("  ‚úÖ Removed", removed, "censored values from", col, "\n")
}
}
cat("\n")
# RULE 3: Handle Missing Data (marked with -- or ** or ^^)
# These are like empty spaces in a coloring book
cat("Rule 3: Handling missing data symbols...\n")
# Only apply to CHARACTER columns (text columns, not number columns)
water_data <- water_data %>%
mutate(across(where(is.character), ~na_if(., "--"))) %>%
mutate(across(where(is.character), ~na_if(., "**"))) %>%
mutate(across(where(is.character), ~na_if(., "^^"))) %>%
mutate(across(where(is.character), ~na_if(., "")))
cat("  ‚úÖ Converted missing symbols to NA (empty)\n\n")
# RULE 4: Handle Non-Detects (values starting with <)
cat("Rule 4: Processing non-detect values (< symbols)...\n")
cat("  ‚úÖ Using numeric columns that follow Mass.gov rules\n\n")
# RULE 5: Remove data with quality flags that indicate problems
cat("Rule 5: Checking data quality flags...\n")
if("DWMQual" %in% names(water_data)) {
problem_flags <- c("i", "m")
before <- nrow(water_data)
water_data <- water_data %>%
filter(is.na(DWMQual) | !grepl("[im]", as.character(DWMQual)))
removed <- before - nrow(water_data)
if(removed > 0) cat("  ‚úÖ Removed", removed, "samples with serious quality issues\n")
}
cat("\n")
# Create a clean numeric dataset for analysis
cat("üî¢ Creating clean numeric dataset...\n")
numeric_cols <- c("Datayear", "nMILEPT", "Latitude", "Longitude",
"nMAXDEPTH", "SampDepth", "RelDepth",
"nSECCHI", "nResult")
available_cols <- numeric_cols[numeric_cols %in% names(water_data)]
water_numeric <- water_data %>%
select(all_of(available_cols)) %>%
mutate(across(everything(), ~as.numeric(as.character(.)))) %>%
filter(if_any(everything(), ~ !is.na(.))) %>%
select(where(~sum(!is.na(.)) > 0))
cat("  ‚úÖ Clean dataset has", nrow(water_numeric), "samples\n")
cat("  ‚úÖ Using", ncol(water_numeric), "numeric measurements\n\n")
skip_correlation <- ncol(water_numeric) < 2
cat("üìÅ Creating output folder for all our graphs...\n")
dir.create("ml_results", showWarnings = FALSE)
cat("  ‚úÖ Folder 'ml_results' is ready!\n\n")
# ============================================================================
# GRAPH 1: Data Cleaning Summary
# ============================================================================
cat("üìä GRAPH 1: Creating Data Cleaning Summary...\n")
cleaning_summary <- data.frame(
Stage = c("Original Data", "After QC Filter", "After Removing\nCensored",
"After Quality\nFlags", "Final Clean\nData"),
Count = c(original_count,
ifelse("QCStatus" %in% names(water_data),
original_count - (original_count - nrow(water_data)),
original_count),
nrow(water_data),
nrow(water_data),
nrow(water_numeric)),
stringsAsFactors = FALSE
)
png("ml_results/01_data_cleaning_funnel.png", width = 1200, height = 800, res = 120)
ggplot(cleaning_summary, aes(x = factor(Stage, levels = Stage), y = Count, fill = Stage)) +
geom_bar(stat = "identity", width = 0.7, color = "black") +
geom_text(aes(label = format(Count, big.mark = ",")),
vjust = -0.5, size = 5, fontface = "bold") +
scale_fill_brewer(palette = "Blues", direction = -1) +
labs(title = "üìä Water Quality Data Cleaning Journey",
subtitle = "How we went from raw data to clean data (following Mass.gov rules)",
x = "Cleaning Stage",
y = "Number of Samples") +
theme_minimal(base_size = 14) +
theme(
plot.title = element_text(face = "bold", size = 18, hjust = 0.5),
plot.subtitle = element_text(size = 12, hjust = 0.5, color = "gray30"),
legend.position = "none",
axis.text.x = element_text(angle = 0, hjust = 0.5),
panel.grid.major.x = element_blank()
) +
scale_y_continuous(labels = scales::comma, expand = expansion(mult = c(0, 0.1)))
dev.off()
cat("  ‚úÖ Saved: 01_data_cleaning_funnel.png\n\n")
# ============================================================================
# GRAPH 2: Data Distribution Histograms
# ============================================================================
cat("üìä GRAPH 2: Creating Data Distribution Histograms...\n")
# Create histograms for all numeric variables
plot_list <- list()
for(i in 1:min(6, ncol(water_numeric))) {
col_name <- names(water_numeric)[i]
p <- ggplot(water_numeric, aes_string(x = col_name)) +
geom_histogram(bins = 30, fill = "steelblue", color = "white", alpha = 0.8) +
labs(title = paste("Distribution of", col_name),
x = col_name, y = "Count") +
theme_minimal(base_size = 10) +
theme(plot.title = element_text(face = "bold", size = 11))
plot_list[[i]] <- p
}
png("ml_results/02_data_distributions.png", width = 1400, height = 1000, res = 120)
do.call(grid.arrange, c(plot_list, ncol = 3))
dev.off()
cat("  ‚úÖ Saved: 02_data_distributions.png\n\n")
if(!skip_correlation) {
cat("üìä GRAPH 3: Creating Correlation Heatmap...\n")
cor_matrix <- cor(water_numeric, use = "pairwise.complete.obs")
png("ml_results/03_correlation_heatmap.png", width = 1200, height = 1000, res = 120)
corrplot(cor_matrix,
method = "color",
type = "upper",
addCoef.col = "black",
number.cex = 0.7,
tl.col = "black",
tl.srt = 45,
tl.cex = 0.9,
col = colorRampPalette(c("#3B9AB2", "white", "#F21A00"))(200),
title = "üî• How Water Quality Measurements Connect to Each Other",
mar = c(0,0,3,0))
dev.off()
cat("  ‚úÖ Saved: 03_correlation_heatmap.png\n\n")
} else {
cat("  ‚ö†Ô∏è  Skipped correlation (need at least 2 variables)\n\n")
}
# ============================================================================
# GRAPH 4: Missing Data Visualization
# ============================================================================
cat("üìä GRAPH 4: Creating Missing Data Pattern...\n")
missing_data <- water_numeric %>%
summarise(across(everything(), ~sum(is.na(.)))) %>%
pivot_longer(everything(), names_to = "Variable", values_to = "Missing_Count") %>%
mutate(Missing_Percent = (Missing_Count / nrow(water_numeric)) * 100)
png("ml_results/04_missing_data_pattern.png", width = 1200, height = 800, res = 120)
ggplot(missing_data, aes(x = reorder(Variable, -Missing_Percent),
y = Missing_Percent, fill = Missing_Percent)) +
geom_bar(stat = "identity", color = "black") +
geom_text(aes(label = paste0(round(Missing_Percent, 1), "%")),
vjust = -0.5, size = 4, fontface = "bold") +
scale_fill_gradient(low = "lightgreen", high = "red") +
labs(title = "üîç Missing Data Detective Work",
subtitle = "Which measurements have missing values?",
x = "Water Quality Measurement",
y = "Percentage Missing (%)") +
theme_minimal(base_size = 14) +
theme(
plot.title = element_text(face = "bold", size = 18, hjust = 0.5),
plot.subtitle = element_text(size = 12, hjust = 0.5),
axis.text.x = element_text(angle = 45, hjust = 1),
legend.position = "none"
)
dev.off()
cat("  ‚úÖ Saved: 04_missing_data_pattern.png\n\n")
cat("ü§ñ Preparing data for Machine Learning...\n\n")
if(!"nMAXDEPTH" %in% names(water_numeric)) {
cat("‚ùå ERROR: Cannot find water depth column (nMAXDEPTH)\n")
cat("   Available columns:", paste(names(water_numeric), collapse = ", "), "\n")
stop("Missing target variable")
}
ml_data <- water_numeric %>%
filter(!is.na(nMAXDEPTH)) %>%
drop_na()
cat("  ‚úÖ We have", nrow(ml_data), "complete samples for training!\n\n")
if(nrow(ml_data) < 20) {
cat("‚ùå ERROR: Too few samples (need at least 20)\n")
stop("Insufficient data")
}
set.seed(123)
train_index <- createDataPartition(ml_data$nMAXDEPTH, p = 0.7, list = FALSE)
train_data <- ml_data[train_index, ]
test_data <- ml_data[-train_index, ]
cat("  üìö Training set:", nrow(train_data), "samples\n")
cat("  üìù Testing set:", nrow(test_data), "samples\n\n")
cat("üå≥ MODEL 1: Growing a Decision Tree...\n\n")
predictors <- setdiff(names(train_data), "nMAXDEPTH")
formula_str <- paste("nMAXDEPTH ~", paste(predictors, collapse = " + "))
tree_formula <- as.formula(formula_str)
tree_model <- rpart(tree_formula,
data = train_data,
method = "anova",
control = rpart.control(minsplit = 10, cp = 0.01))
png("ml_results/05_decision_tree.png", width = 1500, height = 1100, res = 120)
rpart.plot(tree_model,
main = "üå≥ Decision Tree: How to Predict Water Depth",
box.palette = "Blues",
shadow.col = "gray",
nn = TRUE,
cex = 0.8)
dev.off()
tree_predictions <- predict(tree_model, test_data)
tree_results <- data.frame(
Actual = test_data$nMAXDEPTH,
Predicted = tree_predictions
)
if(!"nMAXDEPTH" %in% names(water_numeric)) {
cat("‚ùå ERROR: Cannot find water depth column (nMAXDEPTH)\n")
cat("   Available columns:", paste(names(water_numeric), collapse = ", "), "\n")
stop("Missing target variable")
}
ml_data <- water_numeric %>%
filter(!is.na(nMAXDEPTH)) %>%
drop_na()
cat("  ‚úÖ We have", nrow(ml_data), "complete samples for training!\n\n")
# Clear everything (like cleaning your desk before homework)
rm(list = ls())
# Load our helper tools (like getting out your pencils and crayons)
if (!require("readxl")) install.packages("readxl")
if (!require("dplyr")) install.packages("dplyr")
if (!require("tidyr")) install.packages("tidyr")
if (!require("ggplot2")) install.packages("ggplot2")
if (!require("randomForest")) install.packages("randomForest")
if (!require("caret")) install.packages("caret")
if (!require("corrplot")) install.packages("corrplot")
if (!require("rpart")) install.packages("rpart")
if (!require("rpart.plot")) install.packages("rpart.plot")
if (!require("gridExtra")) install.packages("gridExtra")
if (!require("RColorBrewer")) install.packages("RColorBrewer")
library(readxl)
library(dplyr)
library(tidyr)
library(ggplot2)
library(randomForest)
library(caret)
library(corrplot)
library(rpart)
library(rpart.plot)
library(gridExtra)
library(RColorBrewer)
cat("üìÇ Opening the water quality data file...\n")
file_path <- "C:\\Users\\minak\\Downloads\\labdatamain-8-23-2022.xlsx"
water_data <- read_excel(file_path)
cat("‚úÖ Found", nrow(water_data), "water samples!\n")
cat("‚úÖ Each sample has", ncol(water_data), "pieces of information!\n\n")
cat("üßπ Starting to clean the data...\n\n")
# RULE 1: Only use QC4 and QC5 data (these are the "final, good" data!)
# QC1, QC2, QC3 are like practice drawings - not ready to show yet!
cat("Rule 1: Keeping only FINAL quality data (QC4 and QC5)...\n")
original_count <- nrow(water_data)
if("QCStatus" %in% names(water_data)) {
water_data <- water_data %>%
filter(QCStatus %in% c("QC4", "QC5"))
cat("  ‚úÖ Kept", nrow(water_data), "samples out of", original_count, "\n\n")
} else {
cat("  ‚ö†Ô∏è  No QCStatus column found, keeping all data\n\n")
}
# RULE 2: Remove CENSORED data (marked with ##)
# These are like broken crayons - we can't use them!
cat("Rule 2: Removing censored data (marked with ##)...\n")
censored_columns <- c("ResVal", "SECCHI", "MAXDEPTH")
for(col in censored_columns) {
if(col %in% names(water_data)) {
before <- nrow(water_data)
water_data <- water_data %>%
filter(is.na(get(col)) | !grepl("##", as.character(get(col)), fixed = TRUE))
removed <- before - nrow(water_data)
if(removed > 0) cat("  ‚úÖ Removed", removed, "censored values from", col, "\n")
}
}
cat("\n")
# RULE 3: Handle Missing Data (marked with -- or ** or ^^)
# These are like empty spaces in a coloring book
cat("Rule 3: Handling missing data symbols...\n")
# Only apply to CHARACTER columns (text columns, not number columns)
water_data <- water_data %>%
mutate(across(where(is.character), ~na_if(., "--"))) %>%
mutate(across(where(is.character), ~na_if(., "**"))) %>%
mutate(across(where(is.character), ~na_if(., "^^"))) %>%
mutate(across(where(is.character), ~na_if(., "")))
cat("  ‚úÖ Converted missing symbols to NA (empty)\n\n")
# RULE 4: Handle Non-Detects (values starting with <)
cat("Rule 4: Processing non-detect values (< symbols)...\n")
cat("  ‚úÖ Using numeric columns that follow Mass.gov rules\n\n")
# RULE 5: Remove data with quality flags that indicate problems
cat("Rule 5: Checking data quality flags...\n")
if("DWMQual" %in% names(water_data)) {
problem_flags <- c("i", "m")
before <- nrow(water_data)
water_data <- water_data %>%
filter(is.na(DWMQual) | !grepl("[im]", as.character(DWMQual)))
removed <- before - nrow(water_data)
if(removed > 0) cat("  ‚úÖ Removed", removed, "samples with serious quality issues\n")
}
cat("\n")
# Create a clean numeric dataset for analysis
cat("üî¢ Creating clean numeric dataset...\n")
numeric_cols <- c("Datayear", "nMILEPT", "Latitude", "Longitude",
"nMAXDEPTH", "SampDepth", "RelDepth",
"nSECCHI", "nResult")
available_cols <- numeric_cols[numeric_cols %in% names(water_data)]
water_numeric <- water_data %>%
select(all_of(available_cols)) %>%
mutate(across(everything(), ~as.numeric(as.character(.)))) %>%
filter(if_any(everything(), ~ !is.na(.))) %>%
select(where(~sum(!is.na(.)) > 0))
cat("  ‚úÖ Clean dataset has", nrow(water_numeric), "samples\n")
cat("  ‚úÖ Using", ncol(water_numeric), "numeric measurements\n\n")
skip_correlation <- ncol(water_numeric) < 2
cat("üìÅ Creating output folder for all our graphs...\n")
dir.create("ml_results", showWarnings = FALSE)
cat("  ‚úÖ Folder 'ml_results' is ready!\n\n")
# ============================================================================
# GRAPH 1: Data Cleaning Summary
# ============================================================================
cat("üìä GRAPH 1: Creating Data Cleaning Summary...\n")
cleaning_summary <- data.frame(
Stage = c("Original Data", "After QC Filter", "After Removing\nCensored",
"After Quality\nFlags", "Final Clean\nData"),
Count = c(original_count,
ifelse("QCStatus" %in% names(water_data),
original_count - (original_count - nrow(water_data)),
original_count),
nrow(water_data),
nrow(water_data),
nrow(water_numeric)),
stringsAsFactors = FALSE
)
png("ml_results/01_data_cleaning_funnel.png", width = 1200, height = 800, res = 120)
ggplot(cleaning_summary, aes(x = factor(Stage, levels = Stage), y = Count, fill = Stage)) +
geom_bar(stat = "identity", width = 0.7, color = "black") +
geom_text(aes(label = format(Count, big.mark = ",")),
vjust = -0.5, size = 5, fontface = "bold") +
scale_fill_brewer(palette = "Blues", direction = -1) +
labs(title = "üìä Water Quality Data Cleaning Journey",
subtitle = "How we went from raw data to clean data (following Mass.gov rules)",
x = "Cleaning Stage",
y = "Number of Samples") +
theme_minimal(base_size = 14) +
theme(
plot.title = element_text(face = "bold", size = 18, hjust = 0.5),
plot.subtitle = element_text(size = 12, hjust = 0.5, color = "gray30"),
legend.position = "none",
axis.text.x = element_text(angle = 0, hjust = 0.5),
panel.grid.major.x = element_blank()
) +
scale_y_continuous(labels = scales::comma, expand = expansion(mult = c(0, 0.1)))
dev.off()
water_numeric <- water_data %>%
select(all_of(available_cols)) %>%
mutate(across(everything(), ~as.numeric(as.character(.)))) %>%
filter(if_any(everything(), ~ !is.na(.))) %>%
select(where(~sum(!is.na(.)) > 0))
cat("  ‚úÖ Clean dataset has", nrow(water_numeric), "samples\n")
cat("  ‚úÖ Using", ncol(water_numeric), "numeric measurements\n\n")
skip_correlation <- ncol(water_numeric) < 2
cat("üìÅ Creating output folder for all our graphs...\n")
dir.create("ml_results", showWarnings = FALSE)
cat("  ‚úÖ Folder 'ml_results' is ready!\n\n")
# ============================================================================
# GRAPH 1: Data Cleaning Summary
# ============================================================================
cat("üìä GRAPH 1: Creating Data Cleaning Summary...\n")
cleaning_summary <- data.frame(
Stage = c("Original Data", "After QC Filter", "After Removing\nCensored",
"After Quality\nFlags", "Final Clean\nData"),
Count = c(original_count,
ifelse("QCStatus" %in% names(water_data),
original_count - (original_count - nrow(water_data)),
original_count),
nrow(water_data),
nrow(water_data),
nrow(water_numeric)),
stringsAsFactors = FALSE
)
png("ml_results/01_data_cleaning_funnel.png", width = 1200, height = 800, res = 120)
ggplot(cleaning_summary, aes(x = factor(Stage, levels = Stage), y = Count, fill = Stage)) +
geom_bar(stat = "identity", width = 0.7, color = "black") +
geom_text(aes(label = format(Count, big.mark = ",")),
vjust = -0.5, size = 5, fontface = "bold") +
scale_fill_brewer(palette = "Blues", direction = -1) +
labs(title = "üìä Water Quality Data Cleaning Journey",
subtitle = "How we went from raw data to clean data (following Mass.gov rules)",
x = "Cleaning Stage",
y = "Number of Samples") +
theme_minimal(base_size = 14) +
theme(
plot.title = element_text(face = "bold", size = 18, hjust = 0.5),
plot.subtitle = element_text(size = 12, hjust = 0.5, color = "gray30"),
legend.position = "none",
axis.text.x = element_text(angle = 0, hjust = 0.5),
panel.grid.major.x = element_blank()
) +
scale_y_continuous(labels = scales::comma, expand = expansion(mult = c(0, 0.1)))
library(shiny); runApp('StudentSuccess.R')
runApp('StudentSuccess.R')
runApp('StudentSuccess.R')
runApp('StudentSuccess.R')
runApp('StudentSuccess.R')
runApp('StudentSuccess.R')
runApp('StudentSuccess.R')
runApp('StudentSuccess.R')
runApp('StudentSuccess.R')
runApp('StudentSuccess.R')
runApp('StudentSuccess.R')
runApp('StudentSuccess.R')
runApp('StudentSuccess.R')
runApp('StudentSuccess.R')
View(water_numeric)
View(water_data)
View(cleaning_summary)
library(shiny); runApp('StudentSuccess.R')
runApp('StudentSuccess.R')
runApp('StudentSuccess.R')
gc()
gc()
gc()
gc()
runApp('StudentSuccess.R')
runApp('StudentSuccess.R')
runApp('StudentSuccess.R')
runApp('StudentSuccess.R')
gc()
gc()
gc()
gc()
gc()
gc()
gc()
gc()
gc()
library(shiny); runApp('StudentSuccess.R')
runApp('StudentSuccess.R')
runApp('StudentSuccess.R')
runApp('StudentSuccess.R')
runApp('StudentSuccess.R')
library(shiny); runApp('StudentSuccess.R')
